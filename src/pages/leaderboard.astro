---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/navigationBar/Navbar.astro';
import LeaderboardRow from '../components/leaderboard/leaderboardRow.astro';

// Importing database tools.
import { app } from "../firebase/server";
import { getAuth } from "firebase-admin/auth";
import { getFirestore } from 'firebase-admin/firestore';

// Initalizing the method that will allow us to get the user.
const auth = getAuth(app);

// Importing user interface
import type { userModel } from '../pages/api/interfaces/user';

// Importing the top X best scores for the timed game mode.
import { getXBestTimedScores } from '../pages/api/users/leaderboards.ts';

// Check current session 
if (!Astro.cookies.has("session")) {
  return Astro.redirect("/signin");
}
const sessionCookie = Astro.cookies.get("session").value;
const decodedCookie = await auth.verifySessionCookie(sessionCookie);
const user = await auth.getUser(decodedCookie.uid);

if (!user) {
  return Astro.redirect("/signin");
}

const db = getFirestore(app);
const usersRef = db.collection("users");
const userSnapshot = await usersRef.doc(user.uid).get();

if (!userSnapshot.exists) {
  return Astro.redirect("/404");
}

// Getting the current user.
const currentUser = userSnapshot.data() as userModel;

// Getting the X users with best scores in the timed game mode.
const testingArray = await getXBestTimedScores()
---

<Layout title='leaderboard'>
    <Navbar 
      username={ currentUser.username }, 
      email={ currentUser.email }, 
      userImage='/src/pages/images/mario.png'
    />


  <h1 class="flex justify-center items-center mb-4 text-4xl font-extrabold leading-none tracking-tight text-gray-900 md:text-5xl lg:text-4xl dark:text-white">Leaderboard</h1>

  <div class="relative overflow-x-auto shadow-md sm:rounded-lg">
    <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
            <tr>
                <th scope="col" class="px-6 py-3">
                    Name
                </th>
                <th scope="col" class="px-6 py-3">
                    Rank
                </th>
                <th scope="col" class="px-6 py-3">
                    High score
                </th>
                <th scope="col" class="px-6 py-3">
                    Streak
                </th>
            </tr>
        </thead>
        <tbody>
          <LeaderboardRow 
            username = { testingArray[0].username };
            email = { testingArray[0].email };
            bestScore = { testingArray[0].timedGameMode.bestScore };
            streak = { testingArray[0].timedGameMode.gamesPlayed };
            rank = "# 1";
          ></LeaderboardRow>

          <LeaderboardRow 
            username = { testingArray[1].username };
            email = { testingArray[1].email };
            bestScore = { testingArray[1].timedGameMode.bestScore };
            streak = { testingArray[1].timedGameMode.gamesPlayed };
            rank = "# 2";
          ></LeaderboardRow>

          <LeaderboardRow 
            username = { testingArray[2].username };
            email = { testingArray[2].email };
            bestScore = { testingArray[2].timedGameMode.bestScore };
            streak = { testingArray[2].timedGameMode.gamesPlayed };
            rank = "# 3";
          ></LeaderboardRow>

        </tbody>
    </table>
  </div>

</Layout>
